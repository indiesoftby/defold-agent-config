-- SPDX-License-Identifier: CC0-1.0

local M = {}

local PREF_KEY = "gen_convexshape.max_vertices"
local VERTEX_OPTIONS = {"4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16"}
local SCRIPT_PATH = ".agents/skills/defold-proto-file-editing/scripts/gen_convexshape.py"
local SPRITE_IMAGE_PROP = "__sampler__texture_sampler__0"

function M.get_prefs_schema()
	return {
		[PREF_KEY] = editor.prefs.schema.enum({
			values = VERTEX_OPTIONS,
			default = "16",
			scope = editor.prefs.SCOPE.PROJECT
		})
	}
end

local vertices_dialog = editor.ui.component(function(props)
	local vertices, set_vertices = editor.ui.use_state(props.default_vertices)

	return editor.ui.dialog({
		title = "Generate Convex Shape",
		content = editor.ui.vertical({
			padding = editor.ui.PADDING.LARGE,
			spacing = editor.ui.SPACING.LARGE,
			children = {
				editor.ui.paragraph({
					text = "Generates a .convexshape file from the image's non-transparent pixels. "
						.. "The tool computes a convex hull of the visible silhouette and simplifies "
						.. "it to the specified number of vertices. The result is saved as \""
						.. props.output_name .. "\"."
				}),
				editor.ui.grid({
					columns = {{}, {grow = true}},
					children = {
						{
							editor.ui.label({text = "Image", alignment = editor.ui.ALIGNMENT.RIGHT}),
							editor.ui.label({text = props.image_name})
						},
						{
							editor.ui.label({text = "Max vertices", alignment = editor.ui.ALIGNMENT.RIGHT}),
							editor.ui.select_box({
								value = vertices,
								options = VERTEX_OPTIONS,
								on_value_changed = set_vertices
							})
						}
					}
				})
			}
		}),
		buttons = {
			editor.ui.dialog_button({text = "Cancel", cancel = true}),
			editor.ui.dialog_button({text = "Generate", default = true, result = vertices})
		}
	})
end)

--- Find image resource path for a sprite's default animation from its atlas.
--- Uses the editor API to query atlas images and animations.
---@param atlas_path string resource path to atlas (e.g. "/assets/hero.atlas")
---@param default_animation string animation/image id from the sprite
---@return string|nil image_path resource path to the image file
---@return string|nil error_message
local function find_sprite_image(atlas_path, default_animation)
	-- Check bare images: id is filename without extension
	local image_nodes = editor.get(atlas_path, "images")
	for i = 1, #image_nodes do
		local img_path = editor.get(image_nodes[i], "image")
		local filename = img_path:match("([^/]+)$")
		local img_id = filename:match("^(.+)%.[^.]+$") or filename
		if img_id == default_animation then
			return img_path
		end
	end

	-- Check animations: id is the animation's id field
	local anim_nodes = editor.get(atlas_path, "animations")
	for i = 1, #anim_nodes do
		local anim_id = editor.get(anim_nodes[i], "id")
		if anim_id == default_animation then
			-- Get first image of the animation
			local anim_image_nodes = editor.get(anim_nodes[i], "images")
			if #anim_image_nodes > 0 then
				return editor.get(anim_image_nodes[1], "image")
			end
		end
	end

	-- Fallback: return first image in the atlas
	if #image_nodes > 0 then
		return editor.get(image_nodes[1], "image")
	end
	if #anim_nodes > 0 then
		local anim_image_nodes = editor.get(anim_nodes[1], "images")
		if #anim_image_nodes > 0 then
			return editor.get(anim_image_nodes[1], "image")
		end
	end

	return nil, "No image found for animation '" .. default_animation .. "' in atlas " .. atlas_path
end

--- Generate convexshape content for a collisionobject file.
---@param convexshape_resource_path string resource path (e.g. "/assets/hero.convexshape")
---@return string content collisionobject protobuf text
local function make_collisionobject_content(convexshape_resource_path)
	return 'collision_shape: "' .. convexshape_resource_path .. '"\n'
		.. "type: COLLISION_OBJECT_TYPE_KINEMATIC\n"
		.. "mass: 0.0\n"
		.. "friction: 0.1\n"
		.. "restitution: 0.5\n"
		.. 'group: "default"\n'
		.. 'mask: "default"\n'
end

function M.get_commands()
	return {
		-- DEBUG: temporary command to inspect outline node properties
		{
			label = "DEBUG: Inspect Outline Node",
			locations = {"Outline"},
			query = {
				selection = {type = "outline", cardinality = "one"}
			},
			active = function(opts)
				return true
			end,
			run = function(opts)
				local node = opts.selection
				local props = {"path", "id", "url", "default_animation", SPRITE_IMAGE_PROP}
				for _, prop in ipairs(props) do
					local can = editor.can_get(node, prop)
					local val = can and editor.get(node, prop) or "N/A"
					print(prop .. ": can_get=" .. tostring(can) .. " value=" .. tostring(val))
				end
			end
		},
		-- Command 1: Generate from image file in Assets panel
		{
			label = "Generate Convex Shape...",
			locations = {"Assets"},
			query = {
				selection = {type = "resource", cardinality = "one"}
			},
			active = function(opts)
				local path = editor.get(opts.selection, "path")
				return path:match("%.png$") ~= nil
					or path:match("%.jpg$") ~= nil
					or path:match("%.jpeg$") ~= nil
			end,
			run = function(opts)
				local path = editor.get(opts.selection, "path")
				local image_name = path:match("[^/]+$")
				local output_name = image_name:gsub("%.[^.]+$", ".convexshape")
				local saved_vertices = editor.prefs.get(PREF_KEY)
				local vertices = editor.ui.show_dialog(vertices_dialog({
					image_name = image_name,
					output_name = output_name,
					default_vertices = saved_vertices
				}))
				if not vertices then
					return
				end
				editor.prefs.set(PREF_KEY, vertices)
				local rel_path = path:sub(2)
				local output_path = rel_path:gsub("%.[^.]+$", ".convexshape")
				editor.execute(
					"python",
					SCRIPT_PATH,
					rel_path,
					"-o", output_path,
					"-m", vertices
				)
			end
		},
		-- Command 2: Generate from Sprite component in Outline panel
		{
			label = "Generate Convex Shape...",
			locations = {"Outline"},
			query = {
				selection = {type = "outline", cardinality = "one"}
			},
			active = function(opts)
				local node = opts.selection
				return editor.can_get(node, SPRITE_IMAGE_PROP)
					and editor.can_get(node, "default_animation")
			end,
			run = function(opts)
				local node = opts.selection

				-- Read sprite properties
				local atlas_path = editor.get(node, SPRITE_IMAGE_PROP)
				local default_animation = editor.get(node, "default_animation")

				if not atlas_path or atlas_path == "" then
					print("ERROR: Sprite has no atlas/image set")
					return
				end

				-- Find the actual image file from the atlas
				local image_path, err = find_sprite_image(atlas_path, default_animation)
				if not image_path then
					print("ERROR: " .. (err or "Unknown error"))
					return
				end

				-- Determine output paths
				local image_name = image_path:match("[^/]+$")
				local convexshape_resource_path = image_path:gsub("%.[^.]+$", ".convexshape")
				local output_name = image_name:gsub("%.[^.]+$", ".convexshape")

				-- Show dialog
				local saved_vertices = editor.prefs.get(PREF_KEY)
				local vertices = editor.ui.show_dialog(vertices_dialog({
					image_name = image_name,
					output_name = output_name,
					default_vertices = saved_vertices
				}))
				if not vertices then
					return
				end
				editor.prefs.set(PREF_KEY, vertices)

				-- Generate .convexshape file
				local image_rel_path = image_path:sub(2)
				local convexshape_rel_path = convexshape_resource_path:sub(2)
				editor.execute(
					"python",
					SCRIPT_PATH,
					image_rel_path,
					"-o", convexshape_rel_path,
					"-m", vertices
				)

				-- Create .collisionobject file next to the image
				local collisionobject_resource_path = image_path:gsub("%.[^.]+$", ".collisionobject")
				local co_content = make_collisionobject_content(convexshape_resource_path)

				local attrs = editor.resource_attributes(collisionobject_resource_path)
				if attrs.exists then
					print("Collision object already exists: " .. collisionobject_resource_path)
				else
					editor.create_resources({
						{collisionobject_resource_path, co_content}
					})
					print("Created: " .. collisionobject_resource_path)
				end
			end
		}
	}
end

return M
